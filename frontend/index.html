<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Approval System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .badge-pending {
        background-color: #ffc107;
      }
      .badge-approved {
        background-color: #198754;
      }
      .badge-rejected {
        background-color: #dc3545;
      }
      .nav-tabs .nav-link.active {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <span class="navbar-brand mb-0 h1">üìã Form Approval System</span>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Alert Container -->
      <div id="alertContainer"></div>

      <!-- Tabs -->
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="switchTab('user')"
            >User Portal</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="switchTab('admin')"
            >Admin Panel</a
          >
        </li>
      </ul>

      <!-- User Tab -->
      <div id="userTab" class="tab-content">
        <div class="row mt-3">
          <!-- Form Submission -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5>üìù Submit New Form</h5>
              </div>
              <div class="card-body">
                <form id="submissionForm">
                  <div class="mb-3">
                    <label class="form-label">Full Name *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="name"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email *</label>
                    <input
                      type="email"
                      class="form-control"
                      id="email"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Phone *</label>
                    <input
                      type="tel"
                      class="form-control"
                      id="phone"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Purpose *</label>
                    <select class="form-select" id="purpose" required>
                      <option value="">Select Purpose</option>
                      <option value="Leave Application">
                        Leave Application
                      </option>
                      <option value="Document Request">Document Request</option>
                      <option value="Fee Concession">Fee Concession</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Description *</label>
                    <textarea
                      class="form-control"
                      id="description"
                      rows="3"
                      required
                    ></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary w-100">
                    Submit Form
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Status Check -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h5>üîç Check Status</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">Enter Your Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="checkEmail"
                    placeholder="your@email.com"
                  />
                </div>
                <button class="btn btn-info w-100 mb-3" onclick="checkStatus()">
                  Check Status
                </button>
                <div id="statusResults"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Tab -->
      <div id="adminTab" class="tab-content" style="display: none">
        <div class="card mt-3">
          <div class="card-header bg-warning text-dark">
            <h5>‚ö° Admin Panel - Pending Approvals</h5>
          </div>
          <div class="card-body">
            <button
              class="btn btn-outline-primary mb-3"
              onclick="loadAllForms()"
            >
              üîÑ Refresh List
            </button>
            <div id="formsList">
              <div class="text-center text-muted">Loading forms...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "https://form-submmision.onrender.com/api";

      // Tab Switching
      function switchTab(tab) {
        if (tab === "user") {
          document.getElementById("userTab").style.display = "block";
          document.getElementById("adminTab").style.display = "none";
          document.querySelectorAll(".nav-link")[0].classList.add("active");
          document.querySelectorAll(".nav-link")[1].classList.remove("active");
        } else {
          document.getElementById("userTab").style.display = "none";
          document.getElementById("adminTab").style.display = "block";
          document.querySelectorAll(".nav-link")[0].classList.remove("active");
          document.querySelectorAll(".nav-link")[1].classList.add("active");
          loadAllForms();
        }
      }

      // Show Alert
      function showAlert(message, type = "info") {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        document.getElementById("alertContainer").appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
      }

      // Form Submission
      document
        .getElementById("submissionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            purpose: document.getElementById("purpose").value,
            description: document.getElementById("description").value,
          };

          try {
            const response = await fetch(`${API_BASE}/forms/submit`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (result.success) {
              showAlert(
                "‚úÖ Form submitted successfully! Your request is under review.",
                "success"
              );
              document.getElementById("submissionForm").reset();
            } else {
              showAlert(`‚ùå Error: ${result.message}`, "danger");
            }
          } catch (error) {
            showAlert(
              "‚ùå Network error. Please check backend server.",
              "danger"
            );
          }
        });

      // Check Status
      async function checkStatus() {
        const email = document.getElementById("checkEmail").value.trim();
        if (!email) {
          showAlert("‚ö†Ô∏è Please enter your email address.", "warning");
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/forms/status/${email}`);
          const result = await response.json();

          if (result.success) {
            displayStatusResults(result.data);
          } else {
            showAlert(`‚ùå Error: ${result.message}`, "danger");
            document.getElementById("statusResults").innerHTML = "";
          }
        } catch (error) {
          showAlert("‚ùå Network error. Please try again.", "danger");
        }
      }

      // Display Status Results
      function displayStatusResults(forms) {
        const container = document.getElementById("statusResults");

        if (forms.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">No forms found for this email.</div>';
          return;
        }

        container.innerHTML = `
                <h6>Your Form Submissions:</h6>
                ${forms
                  .map(
                    (form) => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h6>${form.purpose}</h6>
                                <span class="badge badge-${form.status}">
                                    ${form.status.toUpperCase()}
                                </span>
                            </div>
                            <p class="mb-1"><small>Submitted: ${new Date(
                              form.submissionDate
                            ).toLocaleString()}</small></p>
                            <p class="mb-1">${form.description}</p>
                            ${
                              form.adminComments
                                ? `
                                <div class="alert alert-info mt-2 p-2">
                                    <strong>Admin Response:</strong> ${form.adminComments}
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </div>
                `
                  )
                  .join("")}
            `;
      }

      // Load All Forms for Admin
      async function loadAllForms() {
        try {
          const response = await fetch(`${API_BASE}/forms/all`);
          const result = await response.json();

          if (result.success) {
            displayAllForms(result.data);
          } else {
            document.getElementById("formsList").innerHTML = `
                        <div class="alert alert-danger">Error: ${result.message}</div>
                    `;
          }
        } catch (error) {
          document.getElementById("formsList").innerHTML = `
                    <div class="alert alert-danger">Network error. Please check backend server.</div>
                `;
        }
      }

      // Display All Forms in Admin Panel
      function displayAllForms(forms) {
        const container = document.getElementById("formsList");

        if (forms.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">No forms submitted yet.</div>';
          return;
        }

        // Count statistics
        const pendingCount = forms.filter((f) => f.status === "pending").length;
        const approvedCount = forms.filter(
          (f) => f.status === "approved"
        ).length;
        const rejectedCount = forms.filter(
          (f) => f.status === "rejected"
        ).length;

        container.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card text-white bg-warning">
                            <div class="card-body text-center py-2">
                                <h4>${pendingCount}</h4>
                                <small>Pending</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-success">
                            <div class="card-body text-center py-2">
                                <h4>${approvedCount}</h4>
                                <small>Approved</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-danger">
                            <div class="card-body text-center py-2">
                                <h4>${rejectedCount}</h4>
                                <small>Rejected</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Purpose</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Admin Comments</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${forms
                              .map(
                                (form) => `
                                <tr>
                                    <td>${form.name}</td>
                                    <td>${form.email}</td>
                                    <td>${form.purpose}</td>
                                    <td>${new Date(
                                      form.submissionDate
                                    ).toLocaleDateString()}</td>
                                    <td>
                                        <span class="badge badge-${
                                          form.status
                                        }">
                                            ${form.status.toUpperCase()}
                                        </span>
                                    </td>
                                    <td>${form.adminComments || "-"}</td>
                                    <td>
                                        ${
                                          form.status === "pending"
                                            ? `
                                            <button class="btn btn-sm btn-success" onclick="updateStatus('${form._id}', 'approved')">
                                                Approve
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="updateStatus('${form._id}', 'rejected')">
                                                Reject
                                            </button>
                                        `
                                            : "Completed"
                                        }
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;
      }

      // Update Form Status
      async function updateStatus(formId, status) {
        if (!confirm(`Are you sure you want to ${status} this form?`)) return;

        const comments = prompt("Enter comments:") || "";

        try {
          const response = await fetch(`${API_BASE}/forms/${formId}/status`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status, adminComments: comments }),
          });

          const result = await response.json();

          if (result.success) {
            showAlert(`‚úÖ Form ${status} successfully!`, "success");
            loadAllForms();
          } else {
            showAlert(`‚ùå Error: ${result.message}`, "danger");
          }
        } catch (error) {
          showAlert("‚ùå Network error. Please try again.", "danger");
        }
      }

      // Initialize
      console.log("Form Approval System Ready!");
    </script>
  </body>
</html>
